<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Indiagram</title>
    
    <!-- 1. Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React Libraries (Production for Speed) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (Fast Transpiler) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Grand+Hotel&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fafafa; overscroll-behavior: none; }
        .font-insta { font-family: 'Grand Hotel', cursive; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .blue-tick { color: #3b82f6; }
        
        /* Optimized Loading Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #a855f7;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-900 h-screen w-screen overflow-hidden flex flex-col">

    <div id="root" class="h-full w-full flex flex-col">
        <div class="h-full flex flex-col items-center justify-center bg-white">
            <h1 class="font-insta text-4xl text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-orange-500 mb-4">Indiagram</h1>
            <div class="loader"></div>
        </div>
    </div>

    <!-- Main Logic -->
    <script type="text/babel" data-type="module" data-presets="react">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs,
            getDoc,
            onSnapshot, 
            query, 
            where, 
            doc, 
            deleteDoc, 
            setDoc, 
            updateDoc,
            serverTimestamp,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIWFvOKLOpOFfik5YmsERR9pVLjs7tYTc",
            authDomain: "make-a-site.firebaseapp.com",
            projectId: "make-a-site",
            storageBucket: "make-a-site.firebasestorage.app",
            messagingSenderId: "1099071295300",
            appId: "1:1099071295300:web:c5e997a1591b9ffee55111"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const { useState, useEffect, useRef } = React;

        const DEFAULT_AVATAR = "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png";

        // --- UTILS ---
        const formatTimeIST = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour: 'numeric', minute: '2-digit', hour12: true });
        };

        const formatDateIST = (timestamp) => {
            if (!timestamp) return 'Recently';
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata', day: 'numeric', month: 'long', year: 'numeric' });
        };

        const formatLastSeen = (timestamp) => {
            if (!timestamp) return 'Offline';
            const date = new Date(timestamp.seconds * 1000);
            const now = new Date();
            const diffMs = now - date;
            if (diffMs < 120000) return 'Online'; 
            return "Last seen " + date.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: 'numeric', minute: '2-digit', hour12: true });
        };

        // --- COMPONENTS DEFINITIONS ---

        function Navbar({ user, userData, onLogout, setView, activeView, unreadCount, notifCount }) {
            const photo = userData?.photoURL || user.photoURL || DEFAULT_AVATAR;
            const [showSettings, setShowSettings] = useState(false);
            
            return (
                <nav className="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 sticky top-0 z-50 shrink-0">
                    <div className="flex items-center gap-3">
                        <div className="relative">
                            <button onClick={() => setShowSettings(!showSettings)} className="text-slate-700 hover:text-black mt-1">
                                <span className="material-icons-round text-2xl">settings</span>
                            </button>
                            {showSettings && (
                                <div className="absolute top-10 left-0 bg-white border border-slate-200 shadow-lg rounded-lg w-40 py-2 z-[60] animate-fade-in">
                                    <button onClick={onLogout} className="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-slate-50 flex items-center gap-2">
                                        <span className="material-icons-round text-sm">logout</span> Logout
                                    </button>
                                </div>
                            )}
                        </div>
                        
                        <div className="font-insta text-3xl text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-orange-500 cursor-pointer pt-1" onClick={() => setView('feed')}>
                            Indiagram
                        </div>
                    </div>

                    {user && (
                        <div className="flex items-center gap-4">
                            <button onClick={() => setView('feed')} className={`text-slate-700 hover:text-black transition ${activeView === 'feed' ? 'text-black' : ''}`}>
                                <span className="material-icons-round text-3xl">home</span>
                            </button>
                            <button onClick={() => setView('explore')} className={`text-slate-700 hover:text-black transition ${activeView === 'explore' ? 'text-black' : ''}`}>
                                <span className="material-icons-round text-3xl">search</span>
                            </button>
                            <button onClick={() => setView('create_post')} className="text-slate-700 hover:text-black transition">
                                <span className="material-icons-round text-3xl">add_box</span>
                            </button>
                            
                            <button onClick={() => setView('notifications')} className={`text-slate-700 hover:text-black transition relative ${activeView === 'notifications' ? 'text-black' : ''}`}>
                                <span className="material-icons-round text-3xl">favorite_border</span>
                                {notifCount > 0 && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}
                            </button>

                            <button onClick={() => setView('messages')} className={`text-slate-700 hover:text-black transition ${activeView === 'messages' ? 'text-black' : ''} relative`}>
                                <span className="material-icons-round text-3xl">chat</span>
                                {unreadCount > 0 && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}
                            </button>
                            <button onClick={() => setView('my_profile')} className="flex items-center gap-2 hover:opacity-80 transition">
                                <img src={photo} className={`w-8 h-8 rounded-full border border-slate-300 object-cover ${activeView === 'my_profile' ? 'ring-2 ring-black' : ''}`} />
                            </button>
                        </div>
                    )}
                </nav>
            );
        }

        function AuthPage({ setUser }) {
            const [isLogin, setIsLogin] = useState(true);
            const [emailInput, setEmailInput] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [username, setUsername] = useState('');
            const [country, setCountry] = useState('India');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isLogin) {
                        let loginEmail = emailInput;
                        if (!emailInput.includes('@')) {
                            const q = query(collection(db, "users"), where("username", "==", emailInput.toLowerCase()));
                            const snap = await getDocs(q);
                            if (snap.empty) throw new Error("Username not found.");
                            loginEmail = snap.docs[0].data().email;
                        }
                        await signInWithEmailAndPassword(auth, loginEmail, password);
                    } else {
                        if (!username) throw new Error("Username is required");
                        const q = query(collection(db, "users"), where("username", "==", username.toLowerCase()));
                        const snap = await getDocs(q);
                        if(!snap.empty) throw new Error("Username already taken!");

                        const res = await createUserWithEmailAndPassword(auth, emailInput, password);
                        await updateProfile(res.user, { displayName: name, photoURL: "" });
                        
                        await setDoc(doc(db, "users", res.user.uid), {
                            uid: res.user.uid,
                            name: name,
                            username: username.toLowerCase(),
                            email: emailInput,
                            country: country,
                            bio: "", 
                            photoURL: "",
                            isVerified: false,
                            isBanned: false,
                            isPrivate: false, 
                            lastSeen: serverTimestamp(),
                            createdAt: serverTimestamp()
                        });
                    }
                } catch (err) {
                    setError(err.message.replace('Firebase:', ''));
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-purple-50 to-orange-50">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-100">
                        <div className="text-center mb-8">
                            <h2 className="font-insta text-5xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-orange-500">Indiagram</h2>
                            <p className="text-slate-500 font-medium">{isLogin ? 'Login to see photos & videos' : 'Sign up to see photos & videos'}</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-3">
                            {!isLogin && (
                                <>
                                    <input type="text" placeholder="Full Name" required className="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 outline-none text-sm" value={name} onChange={e => setName(e.target.value)} />
                                    <input type="text" placeholder="Username" required className="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 outline-none text-sm" value={username} onChange={e => setUsername(e.target.value)} />
                                    <select value={country} onChange={e => setCountry(e.target.value)} className="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 text-sm">
                                        <option value="India">India</option>
                                        <option value="USA">USA</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </>
                            )}
                            <input type="text" placeholder={isLogin ? "Email or Username" : "Email"} required className="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 outline-none text-sm" value={emailInput} onChange={e => setEmailInput(e.target.value)} />
                            <input type="password" placeholder="Password" required className="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 outline-none text-sm" value={password} onChange={e => setPassword(e.target.value)} />
                            {error && <div className="p-3 text-red-500 text-xs text-center">{error}</div>}
                            <button disabled={loading} className="w-full bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg font-bold transition disabled:opacity-50 text-sm">
                                {loading ? 'Processing...' : (isLogin ? 'Log In' : 'Sign Up')}
                            </button>
                        </form>
                        <div className="text-center mt-6 p-4 border-t border-slate-100">
                            <p className="text-sm text-slate-600">
                                {isLogin ? "Don't have an account?" : "Have an account?"} 
                                <button onClick={() => setIsLogin(!isLogin)} className="text-blue-500 font-bold ml-1">
                                    {isLogin ? 'Sign up' : 'Log in'}
                                </button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        function PostCard({ post, currentUser, onLike, onComment, onShare, onViewProfile, onDelete }) {
            const [comment, setComment] = useState('');
            const isLiked = post.likes?.includes(currentUser.uid);
            const [postUser, setPostUser] = useState(null);

            useEffect(() => {
                const unsub = onSnapshot(doc(db, "users", post.userId), (doc) => {
                    if (doc.exists()) setPostUser(doc.data());
                });
                return () => unsub();
            }, [post.userId]);

            const handlePostComment = (e) => {
                e.preventDefault();
                if (!comment.trim()) return;
                onComment(post.id, comment, post.userId);
                setComment('');
            };

            const handleDeleteComment = async (commentIndex) => {
                if(confirm("Delete this comment?")) {
                    const newComments = post.comments.filter((_, i) => i !== commentIndex);
                    await updateDoc(doc(db, "posts", post.id), { comments: newComments });
                }
            };

            const viewUser = () => {
                if (postUser) {
                    onViewProfile({
                        uid: postUser.uid,
                        name: postUser.name,
                        photoURL: postUser.photoURL,
                        isVerified: postUser.isVerified
                    });
                }
            };

            return (
                <div className="bg-white border border-slate-200 rounded-xl mb-6 overflow-hidden">
                    <div className="p-3 flex items-center justify-between">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={viewUser}>
                            <img src={postUser?.photoURL || DEFAULT_AVATAR} className="w-8 h-8 rounded-full object-cover border" />
                            <span className="font-bold text-sm">{postUser?.username || post.username}</span>
                            {postUser?.isVerified && <span className="material-icons-round text-blue-500 text-base">verified</span>}
                        </div>
                        {currentUser.uid === post.userId && (
                            <button onClick={(e) => {e.stopPropagation(); onDelete(post.id)}} className="text-slate-400 hover:text-red-500">
                                <span className="material-icons-round text-sm">delete</span>
                            </button>
                        )}
                    </div>
                    <img src={post.imageUrl} className="w-full object-cover max-h-[500px]" loading="lazy" />
                    <div className="p-3">
                        <div className="flex gap-4 mb-2">
                            <button onClick={() => onLike(post.id, isLiked, post.userId)} className={`${isLiked ? 'text-red-500' : 'text-slate-800'}`}>
                                <span className="material-icons-round text-3xl">{isLiked ? 'favorite' : 'favorite_border'}</span>
                            </button>
                            <button className="text-slate-800"><span className="material-icons-round text-3xl">mode_comment</span></button>
                            <button onClick={() => onShare(post)} className="text-slate-800"><span className="material-icons-round text-3xl">send</span></button>
                        </div>
                        <p className="text-sm font-bold mb-1">{post.likes?.length || 0} likes</p>
                        <div className="text-sm mb-2">
                            <span className="font-bold mr-2 cursor-pointer" onClick={viewUser}>{postUser?.username || post.username}</span>
                            {post.caption}
                        </div>
                        {post.comments?.length > 0 && (
                            <div className="mb-2 space-y-1">
                                <p className="text-xs text-slate-500 cursor-pointer">View all {post.comments.length} comments</p>
                                {post.comments.slice(-3).map((c, i) => (
                                    <div key={i} className="text-xs flex justify-between group">
                                        <span><span className="font-bold mr-1">{c.username}</span>{c.text}</span>
                                        {(c.userId === currentUser.uid || post.userId === currentUser.uid) && (
                                            <button onClick={() => handleDeleteComment(i)} className="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100"><span className="material-icons-round text-[10px]">close</span></button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                        <p className="text-[10px] text-slate-400 uppercase tracking-wide">{formatDateIST(post.timestamp)}</p>
                        
                        <form onSubmit={handlePostComment} className="mt-3 flex items-center border-t pt-3">
                            <input type="text" placeholder="Add a comment..." className="flex-1 text-sm outline-none" 
                                value={comment} onChange={e => setComment(e.target.value)} />
                            <button disabled={!comment.trim()} className="text-blue-500 text-sm font-bold disabled:opacity-50">Post</button>
                        </form>
                    </div>
                </div>
            );
        }

        function CreatePostModal({ user, onClose }) {
            const [caption, setCaption] = useState('');
            const [image, setImage] = useState(null);
            const [loading, setLoading] = useState(false);
            const fileRef = useRef();

            const handleFile = (e) => {
                const file = e.target.files[0];
                if(file) {
                    if(file.size > 2097152) return alert("Image too big (Max 2MB)");
                    const reader = new FileReader();
                    reader.onload = () => setImage(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handlePost = async () => {
                if(!image) return;
                setLoading(true);
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    const isVerified = userDoc.exists() ? userDoc.data().isVerified : false;

                    await addDoc(collection(db, "posts"), {
                        userId: user.uid,
                        username: user.displayName,
                        userPic: user.photoURL,
                        isVerified: isVerified,
                        imageUrl: image,
                        caption: caption,
                        likes: [],
                        comments: [],
                        timestamp: serverTimestamp()
                    });
                    alert("Posted!");
                    onClose();
                } catch(e) { alert("Error posting: " + e.message); }
                finally { setLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[100] bg-black/70 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl w-full max-w-md overflow-hidden">
                        <div className="p-3 border-b text-center font-bold relative">
                            Create new post
                            <button onClick={onClose} className="absolute right-3 top-3 text-red-500 text-sm">Cancel</button>
                        </div>
                        <div className="p-4 flex flex-col items-center">
                            {image ? (
                                <div className="w-full mb-4">
                                    <img src={image} className="w-full max-h-64 object-contain rounded bg-black" />
                                    <button onClick={() => setImage(null)} className="text-red-500 text-xs mt-2">Remove</button>
                                </div>
                            ) : (
                                <div onClick={() => fileRef.current.click()} className="w-full h-48 border-2 border-dashed border-slate-300 rounded flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50">
                                    <span className="material-icons-round text-4xl text-slate-400">add_photo_alternate</span>
                                    <p className="text-slate-500 text-sm mt-2">Upload Photo</p>
                                </div>
                            )}
                            <input type="file" ref={fileRef} className="hidden" accept="image/*" onChange={handleFile} />
                            <textarea className="w-full border rounded p-2 mt-4 text-sm outline-none resize-none" rows="3" placeholder="Write a caption..." value={caption} onChange={e => setCaption(e.target.value)}></textarea>
                            <button disabled={!image || loading} onClick={handlePost} className="w-full bg-blue-500 text-white py-2 rounded mt-4 font-bold disabled:opacity-50">
                                {loading ? 'Sharing...' : 'Share'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function PostViewModal({ post, currentUser, onClose, onLike, onComment, onShare, onDelete }) {
            return (
                <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="w-full max-w-lg bg-white rounded-xl overflow-hidden max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="sticky top-0 bg-white z-10 flex justify-end p-2 border-b">
                            <button onClick={onClose}><span className="material-icons-round">close</span></button>
                        </div>
                        <PostCard 
                            post={post} 
                            currentUser={currentUser}
                            onLike={onLike}
                            onComment={onComment}
                            onShare={onShare}
                            onDelete={(id) => { onDelete(id); onClose(); }}
                            onViewProfile={() => {}}
                        />
                    </div>
                </div>
            );
        }

        function ExploreChatView({ user, userData, viewType, setViewingProfile }) {
            const [usersList, setUsersList] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [requests, setRequests] = useState([]);

            useEffect(() => {
                const qReq = query(collection(db, "friend_requests"), where("to", "==", user.uid), where("status", "==", "pending"));
                onSnapshot(qReq, (snap) => setRequests(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            }, [user]);

            const handleSearch = async () => {
                if(!searchQuery.trim()) return;
                const snap = await getDocs(query(collection(db, "users"), limit(20)));
                const results = snap.docs.map(d => d.data()).filter(u => 
                    u.uid !== user.uid && (u.username.includes(searchQuery.toLowerCase()) || u.name.toLowerCase().includes(searchQuery.toLowerCase()))
                );
                setUsersList(results);
            };

            const acceptRequest = async (id) => await updateDoc(doc(db, "friend_requests", id), { status: 'accepted' });

            return (
                <div className="bg-white rounded-xl shadow-sm border flex flex-col h-[80vh] overflow-hidden">
                    <div className="p-4 border-b">
                        <div className="relative">
                            <input className="w-full bg-slate-100 p-2 pl-9 rounded-lg text-sm outline-none" placeholder="Search" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSearch()} />
                            <span className="material-icons-round absolute left-2 top-2 text-slate-400 text-sm">search</span>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2">
                        {requests.length > 0 && (
                            <div className="mb-4">
                                <h3 className="font-bold text-sm mb-2 px-2">Follow Requests</h3>
                                {requests.map(r => (
                                    <div key={r.id} className="flex justify-between items-center mb-2 p-2 bg-slate-50 rounded-lg">
                                        <span className="text-sm font-bold">{r.fromName}</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => acceptRequest(r.id)} className="bg-blue-500 text-white text-xs px-3 py-1 rounded">Confirm</button>
                                            <button onClick={() => deleteDoc(doc(db, "friend_requests", r.id))} className="bg-slate-200 text-xs px-3 py-1 rounded">Delete</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        {usersList.map(u => (
                            <div key={u.uid} className="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-lg cursor-pointer" onClick={() => setViewingProfile(u)}>
                                <img src={u.photoURL || DEFAULT_AVATAR} className="w-10 h-10 rounded-full object-cover bg-slate-200" />
                                <div>
                                    <p className="text-sm font-bold">{u.name} {u.isVerified && <span className="material-icons-round text-blue-500 text-sm">verified</span>}</p>
                                    <p className="text-xs text-slate-500">@{u.username}</p>
                                </div>
                            </div>
                        ))}
                        {!searchQuery && requests.length === 0 && <p className="text-center text-slate-400 mt-10">Search for users to follow.</p>}
                    </div>
                </div>
            );
        }

        function MessagesView({ user, activeChat, setActiveChat, onViewProfile }) {
            const [activeTab, setActiveTab] = useState('primary'); // 'primary' or 'requests'
            const [primaryList, setPrimaryList] = useState([]);
            const [requestList, setRequestList] = useState([]);

            useEffect(() => {
                // Fetch ALL requests related to user
                const q1 = query(collection(db, "friend_requests"), where("from", "==", user.uid));
                const q2 = query(collection(db, "friend_requests"), where("to", "==", user.uid));

                // We need to listen to both and merge. For simplicity in this demo, let's just listen to accepted vs pending logic
                // PRIMARY: Status 'accepted' (Both directions)
                // REQUESTS: Status 'pending' AND 'to' == user.uid
                
                // Fetch Primary (Accepted)
                // NOTE: Firestore OR queries are limited. We'll setup listeners for the specific criteria.
                
                // Listener 1: I sent, they accepted
                const unsub1 = onSnapshot(query(collection(db, "friend_requests"), where("from", "==", user.uid), where("status", "==", "accepted")), async (snap) => {
                    const ids = snap.docs.map(d => d.data().to);
                    if(ids.length > 0) fetchUsers(ids, 'primary_sent');
                    else setPrimaryList(prev => prev.filter(u => u.source !== 'sent')); // simplistic cleanup
                });

                // Listener 2: They sent, I accepted
                const unsub2 = onSnapshot(query(collection(db, "friend_requests"), where("to", "==", user.uid), where("status", "==", "accepted")), async (snap) => {
                    const ids = snap.docs.map(d => d.data().from);
                    if(ids.length > 0) fetchUsers(ids, 'primary_rec');
                });

                // Listener 3: Requests (They sent, status pending)
                const unsub3 = onSnapshot(query(collection(db, "friend_requests"), where("to", "==", user.uid), where("status", "==", "pending")), async (snap) => {
                    const ids = snap.docs.map(d => d.data().from);
                    if(ids.length > 0) fetchUsers(ids, 'requests');
                    else setRequestList([]);
                });

                return () => { unsub1(); unsub2(); unsub3(); };
            }, [user]);

            const fetchUsers = async (ids, type) => {
                if(ids.length === 0) return;
                // Chunking for > 10 ids if needed, ignoring for demo
                const q = query(collection(db, "users"), where("uid", "in", ids.slice(0, 10)));
                const snap = await getDocs(q);
                const users = snap.docs.map(d => d.data());
                
                if (type === 'requests') {
                    setRequestList(users);
                } else {
                    setPrimaryList(prev => {
                        // Merge and deduplicate
                        const combined = [...prev, ...users];
                        const unique = combined.filter((v,i,a)=>a.findIndex(v2=>(v2.uid===v.uid))===i);
                        return unique;
                    });
                }
            };

            if (activeChat) return <div className="h-[80vh] bg-white rounded-xl border overflow-hidden"><ChatWindow currentUser={user} targetUser={activeChat} onBack={() => setActiveChat(null)} onViewProfile={onViewProfile} /></div>;

            return (
                <div className="bg-white rounded-xl shadow-sm border h-[80vh] flex flex-col overflow-hidden">
                    <div className="p-4 border-b">
                         <div className="flex justify-between items-center mb-4">
                            <span className="font-bold text-lg">Messages</span>
                            <span className="material-icons-round text-slate-800">edit_note</span>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            <button onClick={() => setActiveTab('primary')} className={`flex-1 py-1.5 text-sm rounded-md font-bold transition relative ${activeTab === 'primary' ? 'bg-white shadow-sm text-black' : 'text-slate-500'}`}>
                                Primary
                                {primaryList.some(u => false) && <span className="absolute top-1 right-3 w-2 h-2 bg-red-500 rounded-full"></span>}
                            </button>
                            <button onClick={() => setActiveTab('requests')} className={`flex-1 py-1.5 text-sm rounded-md font-bold transition relative ${activeTab === 'requests' ? 'bg-white shadow-sm text-black' : 'text-slate-500'}`}>
                                Requests
                                {requestList.length > 0 && <span className="absolute top-1 right-3 w-2 h-2 bg-red-500 rounded-full"></span>}
                            </button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2">
                        {(activeTab === 'primary' ? primaryList : requestList).map(u => (
                            <div key={u.uid} className="flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg cursor-pointer" onClick={() => setActiveChat(u)}>
                                <div className="flex items-center gap-3">
                                    <img src={u.photoURL || DEFAULT_AVATAR} className="w-12 h-12 rounded-full object-cover bg-slate-200" />
                                    <div>
                                        <p className="text-sm font-bold flex items-center gap-1">{u.name} {u.isVerified && <span className="material-icons-round text-blue-500 text-xs">verified</span>}</p>
                                        <p className="text-xs text-slate-500">Tap to chat</p>
                                    </div>
                                </div>
                                <span className="material-icons-round text-slate-400">navigate_next</span>
                            </div>
                        ))}
                        {(activeTab === 'primary' ? primaryList : requestList).length === 0 && <p className="text-center text-slate-400 mt-10">No messages.</p>}
                    </div>
                </div>
            );
        }

        function ChatWindow({ currentUser, targetUser, onBack, onViewProfile }) {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const scrollRef = useRef();
            const [fullUser, setFullUser] = useState(targetUser);

            useEffect(() => {
                const unsubUser = onSnapshot(doc(db, "users", targetUser.uid), (doc) => {
                    if (doc.exists()) setFullUser(doc.data());
                });

                const chatId = [currentUser.uid, targetUser.uid].sort().join('_');
                const q = query(collection(db, "messages"), where("chatId", "==", chatId));
                const unsub = onSnapshot(q, (snap) => {
                    const msgs = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    setMessages(msgs);
                    setTimeout(() => scrollRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
                });
                return () => { unsub(); unsubUser(); }
            }, [targetUser]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if(!input.trim()) return;
                const chatId = [currentUser.uid, targetUser.uid].sort().join('_');
                await addDoc(collection(db, "messages"), { 
                    chatId, text: input, senderId: currentUser.uid, receiverId: targetUser.uid, timestamp: serverTimestamp() 
                });
                setInput('');
            };

            const deleteMessage = async (id) => { if(confirm("Unsend message?")) await deleteDoc(doc(db, "messages", id)); };

            const deleteChat = async () => {
                if(confirm("Delete entire conversation? This cannot be undone.")) {
                    const chatId = [currentUser.uid, targetUser.uid].sort().join('_');
                    const q = query(collection(db, "messages"), where("chatId", "==", chatId));
                    const snap = await getDocs(q);
                    snap.forEach(d => deleteDoc(d.ref));
                    onBack();
                }
            };

            return (
                <div className="flex flex-col h-full bg-white">
                    <div className="px-4 py-3 border-b flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <button onClick={onBack}><span className="material-icons-round">arrow_back</span></button>
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => onViewProfile(fullUser)}>
                                <img src={fullUser.photoURL || DEFAULT_AVATAR} className="w-8 h-8 rounded-full object-cover" />
                                <div>
                                    <h3 className="font-bold text-sm flex items-center gap-1">
                                        {fullUser.name} 
                                        {fullUser.isVerified && <span className="material-icons-round text-blue-500 text-sm">verified</span>}
                                    </h3>
                                    <p className="text-[10px] text-green-500 font-bold">{formatLastSeen(fullUser.lastSeen)}</p>
                                </div>
                            </div>
                        </div>
                        <button onClick={deleteChat} className="text-red-500 text-xs font-bold border border-red-100 px-2 py-1 rounded">Delete Chat</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-50">
                        {messages.map(msg => (
                            <div key={msg.id} className={`flex ${msg.senderId === currentUser.uid ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[70%] flex flex-col ${msg.senderId === currentUser.uid ? 'items-end' : 'items-start'}`}>
                                    <div 
                                        onClick={() => msg.senderId === currentUser.uid && deleteMessage(msg.id)}
                                        className={`px-4 py-2 rounded-2xl text-sm cursor-pointer hover:opacity-90 ${msg.senderId === currentUser.uid ? 'bg-blue-500 text-white' : 'bg-white text-slate-800 border'}`}
                                    >
                                        {msg.text}
                                    </div>
                                    <span className="text-[9px] text-slate-400 mt-1 px-1">{formatTimeIST(msg.timestamp)}</span>
                                </div>
                            </div>
                        ))}
                        <div ref={scrollRef}></div>
                    </div>
                    <form onSubmit={sendMessage} className="p-3 border-t flex gap-2 bg-white">
                        <input value={input} onChange={e => setInput(e.target.value)} placeholder="Message..." className="flex-1 bg-slate-100 rounded-full px-4 text-sm outline-none" />
                        <button disabled={!input.trim()} className="text-blue-500 font-bold text-sm">Send</button>
                    </form>
                </div>
            );
        }

        function UserListModal({ title, users, onClose, onViewProfile }) {
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white rounded-xl w-full max-w-sm overflow-hidden flex flex-col max-h-[70vh] animate-fade-in shadow-2xl">
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold">{title}</h3>
                            <button onClick={onClose}><span className="material-icons-round">close</span></button>
                        </div>
                        <div className="overflow-y-auto p-2">
                            {users.length === 0 ? <p className="text-center p-4 text-slate-500 text-sm">No users found.</p> : 
                             users.map(u => (
                                <div key={u.uid} className="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-lg cursor-pointer" onClick={() => { onClose(); onViewProfile(u); }}>
                                    <img src={u.photoURL || DEFAULT_AVATAR} className="w-10 h-10 rounded-full bg-slate-200 object-cover" />
                                    <div>
                                        <p className="font-bold text-sm flex items-center gap-1">{u.name} {u.isVerified && <span className="material-icons-round text-blue-500 text-sm">verified</span>}</p>
                                        <p className="text-xs text-slate-500">@{u.username}</p>
                                    </div>
                                </div>
                             ))
                            }
                        </div>
                    </div>
                </div>
            );
        }

        function UserProfileModal({ currentUser, targetUser, onClose, isAdmin, onViewProfile, onMessage, onAddNotif, onViewPost }) {
            const [posts, setPosts] = useState([]);
            const [fullTargetUser, setFullTargetUser] = useState(targetUser);
            const [relationship, setRelationship] = useState('none');
            const [followerCount, setFollowerCount] = useState(0);
            const [followingCount, setFollowingCount] = useState(0);
            const [showList, setShowList] = useState(null);
            const [listData, setListData] = useState([]);
            const [showMenu, setShowMenu] = useState(false);

            useEffect(() => {
                if(!targetUser.uid) return;
                const fetchUser = async () => {
                    const docSnap = await getDoc(doc(db, "users", targetUser.uid));
                    if(docSnap.exists()) setFullTargetUser(docSnap.data());
                };
                fetchUser();

                const qRel = query(collection(db, "friend_requests"), where("from", "==", currentUser.uid), where("to", "==", targetUser.uid));
                onSnapshot(qRel, (snap) => {
                    if(!snap.empty) {
                        const status = snap.docs[0].data().status;
                        setRelationship(status === 'accepted' ? 'following' : 'requested');
                    } else setRelationship('none');
                });

                const qPosts = query(collection(db, "posts"), where("userId", "==", targetUser.uid));
                onSnapshot(qPosts, snap => {
                    const rawPosts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    rawPosts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setPosts(rawPosts);
                });

                const qFollowers = query(collection(db, "friend_requests"), where("to", "==", targetUser.uid), where("status", "==", "accepted"));
                onSnapshot(qFollowers, snap => setFollowerCount(snap.size));
                
                const qFollowing = query(collection(db, "friend_requests"), where("from", "==", targetUser.uid), where("status", "==", "accepted"));
                onSnapshot(qFollowing, snap => setFollowingCount(snap.size));
            }, [targetUser, currentUser]);

            const canView = !fullTargetUser.isPrivate || relationship === 'following' || targetUser.uid === currentUser.uid;

            const handleFollow = async () => {
                const status = fullTargetUser.isPrivate ? 'pending' : 'accepted';
                await addDoc(collection(db, "friend_requests"), {
                    from: currentUser.uid, fromName: currentUser.name, to: targetUser.uid, status: status, timestamp: serverTimestamp()
                });
                onAddNotif(targetUser.uid, 'follow');
            };

            const handleUnfollow = async () => {
                const q = query(collection(db, "friend_requests"), where("from", "==", currentUser.uid), where("to", "==", targetUser.uid));
                const snap = await getDocs(q);
                snap.forEach(d => deleteDoc(d.ref));
            };

            const handleAction = async (action) => {
                try {
                    if (action === 'block') {
                         await addDoc(collection(db, "friend_requests"), { from: currentUser.uid, to: targetUser.uid, status: 'blocked', blockedBy: currentUser.uid, timestamp: serverTimestamp() });
                         alert("User Blocked"); onClose();
                    } else if (action === 'toggle_verify') {
                        const newStatus = !fullTargetUser.isVerified;
                        const updateData = { isVerified: newStatus, verifiedAt: newStatus ? serverTimestamp() : null };
                        await updateDoc(doc(db, "users", targetUser.uid), updateData);
                        setFullTargetUser(prev => ({...prev, isVerified: newStatus}));
                    } else if (action === 'toggle_ban') {
                        const newStatus = !fullTargetUser.isBanned;
                        await updateDoc(doc(db, "users", targetUser.uid), { isBanned: newStatus });
                        setFullTargetUser(prev => ({...prev, isBanned: newStatus}));
                    }
                } catch(e) { alert("Error: " + e.message); }
            };

            const openList = async (type) => {
                if (!canView) return;
                setShowList(type);
                setListData([]);
                const field = type === 'followers' ? 'to' : 'from';
                const targetField = type === 'followers' ? 'from' : 'to';
                const q = query(collection(db, "friend_requests"), where(field, "==", targetUser.uid), where("status", "==", "accepted"));
                const snap = await getDocs(q);
                const ids = snap.docs.map(d => d.data()[targetField]);
                if (ids.length > 0) {
                    const chunks = []; for (let i = 0; i < ids.length; i += 10) chunks.push(ids.slice(i, i + 10));
                    let users = []; for (let chunk of chunks) { const qU = query(collection(db, "users"), where("uid", "in", chunk)); const s = await getDocs(qU); users = [...users, ...s.docs.map(d => d.data())]; }
                    setListData(users);
                }
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white rounded-xl w-full max-w-2xl h-[85vh] overflow-hidden flex flex-col md:flex-row shadow-2xl relative">
                        {/* 3 Dots Menu */}
                        <div className="absolute top-4 left-4 z-50">
                            <button onClick={() => setShowMenu(!showMenu)} className="bg-white/80 rounded-full p-1 hover:bg-white"><span className="material-icons-round">more_horiz</span></button>
                            {showMenu && (
                                <div className="absolute top-8 left-0 bg-white shadow-lg rounded-lg w-48 py-2 border z-50">
                                    <div className="px-4 py-2 border-b">
                                        <p className="text-xs text-slate-500 uppercase font-bold">About this account</p>
                                        <p className="text-xs">Joined: {formatDateIST(fullTargetUser.createdAt)}</p>
                                        <p className="text-xs">Based in: {fullTargetUser.country}</p>
                                    </div>
                                    <button onClick={() => handleAction('block')} className="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-slate-50">Block User</button>
                                </div>
                            )}
                        </div>

                        <div className="p-6 border-b md:border-r md:w-5/12 flex flex-col items-center text-center overflow-y-auto pt-10">
                            <img src={fullTargetUser.photoURL || DEFAULT_AVATAR} className="w-24 h-24 rounded-full border p-1 mb-3 object-cover" />
                            <h2 className="font-bold text-xl flex items-center gap-1">
                                {fullTargetUser.name} {fullTargetUser.isVerified && <span className="material-icons-round text-blue-500 text-xl">verified</span>}
                            </h2>
                            <p className="text-slate-500 text-sm mb-2">@{fullTargetUser.username}</p>
                            {/* Bio Display */}
                            {fullTargetUser.bio && <p className="text-sm text-slate-700 mb-4 px-2">{fullTargetUser.bio}</p>}
                            
                            <div className="flex justify-around w-full mb-6 text-sm">
                                <div><span className="font-bold block text-lg">{posts.length}</span><span className="text-slate-500">Posts</span></div>
                                <div className="cursor-pointer" onClick={() => openList('followers')}><span className="font-bold block text-lg">{followerCount}</span><span className="text-slate-500">Followers</span></div>
                                <div className="cursor-pointer" onClick={() => openList('following')}><span className="font-bold block text-lg">{followingCount}</span><span className="text-slate-500">Following</span></div>
                            </div>

                            {targetUser.uid !== currentUser.uid && (
                                <div className="w-full space-y-2 mb-6">
                                    {relationship === 'none' && <button onClick={handleFollow} className="bg-blue-500 text-white px-6 py-2 rounded-lg font-bold text-sm w-full">Follow</button>}
                                    {relationship === 'requested' && <button onClick={handleUnfollow} className="bg-slate-100 text-slate-700 px-6 py-2 rounded-lg font-bold text-sm w-full">Requested</button>}
                                    {relationship === 'following' && (
                                        <div className="flex gap-2">
                                            <button onClick={() => onMessage(targetUser)} className="flex-1 bg-slate-100 text-slate-700 py-2 rounded-lg font-bold text-sm">Message</button>
                                            <button onClick={handleUnfollow} className="flex-1 bg-slate-100 text-slate-700 py-2 rounded-lg font-bold text-sm">Unfollow</button>
                                        </div>
                                    )}
                                    <button onClick={() => handleAction('block')} className="text-red-500 text-xs font-bold w-full py-2 border border-red-100 rounded-lg hover:bg-red-50">Block</button>
                                </div>
                            )}

                            {isAdmin && (
                                <div className="mt-4 p-3 bg-slate-900 rounded-xl text-white w-full text-center">
                                    <p className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Admin Controls</p>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => handleAction('toggle_verify')} className="text-xs py-2 bg-blue-600 rounded hover:bg-blue-700">{fullTargetUser.isVerified ? 'Remove Badge' : 'Give Blue Tick'}</button>
                                        <button onClick={() => handleAction('toggle_ban')} className="text-xs py-2 bg-red-600 rounded hover:bg-red-700">{fullTargetUser.isBanned ? 'Unban User' : 'Ban User'}</button>
                                    </div>
                                </div>
                            )}

                            <button onClick={onClose} className="mt-auto pt-6 text-slate-400 hover:text-black">Close</button>
                        </div>

                        <div className="flex-1 bg-white overflow-y-auto p-1">
                            {canView ? (
                                <div className="grid grid-cols-3 gap-1">
                                    {posts.map((p, i) => (
                                        <div key={i} className="aspect-square bg-slate-100 relative group cursor-pointer" onClick={() => onViewPost(p)}>
                                            <img src={p.imageUrl} className="w-full h-full object-cover" />
                                            <div className="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center text-white gap-2"><span className="material-icons-round text-sm">favorite</span> {p.likes?.length}</div>
                                        </div>
                                    ))}
                                    {posts.length === 0 && <div className="col-span-3 text-center py-20 text-slate-400">No posts yet</div>}
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full text-center p-6">
                                    <div className="w-16 h-16 border-2 border-slate-300 rounded-full flex items-center justify-center mb-4"><span className="material-icons-round text-3xl text-slate-400">lock</span></div>
                                    <h3 className="font-bold">This Account is Private</h3>
                                    <p className="text-sm text-slate-500">Follow to see their photos and videos.</p>
                                </div>
                            )}
                        </div>
                    </div>
                    {showList && <UserListModal title={showList} users={listData} onClose={() => setShowList(null)} onViewProfile={onViewProfile} />}
                </div>
            );
        }

        function MyProfile({ user, onEdit, onLogout, onViewProfile, onViewPost }) {
            const [userData, setUserData] = useState(null);
            const [myPosts, setMyPosts] = useState([]);
            const [followerCount, setFollowerCount] = useState(0);
            const [followingCount, setFollowingCount] = useState(0);
            const [showList, setShowList] = useState(null);
            const [listData, setListData] = useState([]);

            useEffect(() => {
                getDoc(doc(db, "users", user.uid)).then(d => setUserData(d.data()));
                const qPosts = query(collection(db, "posts"), where("userId", "==", user.uid));
                onSnapshot(qPosts, snap => {
                    const rawPosts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    rawPosts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setMyPosts(rawPosts);
                });
                const qFollowers = query(collection(db, "friend_requests"), where("to", "==", user.uid), where("status", "==", "accepted"));
                onSnapshot(qFollowers, snap => setFollowerCount(snap.size));
                const qFollowing = query(collection(db, "friend_requests"), where("from", "==", user.uid), where("status", "==", "accepted"));
                onSnapshot(qFollowing, snap => setFollowingCount(snap.size));
            }, [user]);

            const openList = async (type) => {
                setShowList(type);
                setListData([]);
                const field = type === 'followers' ? 'to' : 'from';
                const targetField = type === 'followers' ? 'from' : 'to';
                const q = query(collection(db, "friend_requests"), where(field, "==", user.uid), where("status", "==", "accepted"));
                const snap = await getDocs(q);
                const ids = snap.docs.map(d => d.data()[targetField]);
                if (ids.length > 0) {
                    const chunks = [];
                    for (let i = 0; i < ids.length; i += 10) chunks.push(ids.slice(i, i + 10));
                    let users = [];
                    for (let chunk of chunks) {
                        const qU = query(collection(db, "users"), where("uid", "in", chunk));
                        const s = await getDocs(qU);
                        users = [...users, ...s.docs.map(d => d.data())];
                    }
                    setListData(users);
                }
            };

            const toggleMyVerification = async () => {
                if(userData.username !== 'admin') return;
                const newStatus = !userData.isVerified;
                const updateData = { isVerified: newStatus, verifiedAt: newStatus ? serverTimestamp() : null };
                await updateDoc(doc(db, "users", user.uid), updateData);
                setUserData({...userData, ...updateData});
            };

            if(!userData) return <div className="loader"></div>;

            return (
                <div className="flex flex-col h-full bg-white">
                    <div className="p-6 flex gap-6 items-center border-b">
                        <img src={userData.photoURL || DEFAULT_AVATAR} className="w-24 h-24 rounded-full border p-1 object-cover" />
                        <div className="flex-1">
                            <h2 className="text-xl font-bold flex items-center gap-1">{userData.username} {userData.isVerified && <span className="material-icons-round text-blue-500 text-xl">verified</span>}</h2>
                            <div className="flex gap-4 my-3 text-sm">
                                <span><b>{myPosts.length}</b> posts</span>
                                <span className="cursor-pointer" onClick={() => openList('followers')}><b>{followerCount}</b> followers</span>
                                <span className="cursor-pointer" onClick={() => openList('following')}><b>{followingCount}</b> following</span>
                            </div>
                            <div className="text-sm font-bold">{userData.name}</div>
                            {userData.bio && <div className="text-sm text-slate-800">{userData.bio}</div>}
                            <p className="text-xs text-slate-500">{userData.country}</p>
                        </div>
                    </div>
                    <div className="p-4 flex gap-2">
                        <button onClick={onEdit} className="flex-1 bg-slate-100 py-1.5 rounded-lg text-sm font-bold">Edit Profile</button>
                    </div>
                    {userData.username === 'admin' && (
                        <div className="px-4 pb-4"><button onClick={toggleMyVerification} className="w-full bg-slate-800 text-white py-2 rounded-lg text-xs font-bold">{userData.isVerified ? 'Remove My Blue Tick' : 'Get Blue Tick (Admin)'}</button></div>
                    )}
                    <div className="grid grid-cols-3 gap-1 flex-1 overflow-y-auto">
                        {myPosts.map((p, i) => (
                            <div key={i} className="aspect-square relative group bg-slate-100" onClick={() => onViewPost(p)}>
                                <img src={p.imageUrl} className="w-full h-full object-cover" />
                            </div>
                        ))}
                    </div>
                    {showList && <UserListModal title={showList} users={listData} onClose={() => setShowList(null)} onViewProfile={onViewProfile} />}
                </div>
            );
        }

        function EditProfile({ user, onClose }) {
            const [data, setData] = useState({ name: '', username: '', country: 'India', photoURL: '', bio: '', isPrivate: false });
            const [loading, setLoading] = useState(false);
            const fileRef = useRef();

            useEffect(() => {
                getDoc(doc(db, "users", user.uid)).then(d => {
                    if(d.exists()) setData({ ...d.data(), photoURL: d.data().photoURL || '' });
                });
            }, []);

            const handleFile = (e) => {
                const file = e.target.files[0];
                if(file && file.size < 2097152) {
                    const reader = new FileReader();
                    reader.onload = () => setData({...data, photoURL: reader.result});
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await updateDoc(doc(db, "users", user.uid), data);
                    await updateProfile(auth.currentUser, { displayName: data.name, photoURL: data.photoURL });
                    alert("Saved!"); onClose();
                } catch(e) { alert(e.message); } finally { setLoading(false); }
            };

            const handleDeleteAccount = async () => {
                if(confirm("ARE YOU SURE? This will permanently delete your account.")) {
                    try { await deleteDoc(doc(db, "users", user.uid)); await deleteUser(user); } catch(e) { alert("Please login again freshly to delete account securely."); }
                }
            };

            return (
                <div className="bg-white h-full p-6 overflow-y-auto">
                    <div className="flex justify-between items-center mb-6"><button onClick={onClose}>Cancel</button><h2 className="font-bold">Edit Profile</h2><button onClick={handleSave} className="text-blue-500 font-bold" disabled={loading}>Done</button></div>
                    <div className="flex flex-col items-center mb-6">
                        <img src={data.photoURL || DEFAULT_AVATAR} className="w-20 h-20 rounded-full mb-3 object-cover" />
                        <button onClick={() => fileRef.current.click()} className="text-blue-500 text-sm font-bold">Change Profile Photo</button>
                        {data.photoURL && <button onClick={() => setData({...data, photoURL: ''})} className="text-red-500 text-xs mt-2">Remove Photo</button>}
                        <input type="file" ref={fileRef} className="hidden" accept="image/*" onChange={handleFile} />
                    </div>
                    <div className="space-y-4 text-sm">
                        <div><label className="text-xs text-slate-500">Name</label><input className="w-full border-b py-2 outline-none" value={data.name} onChange={e => setData({...data, name: e.target.value})} /></div>
                        <div><label className="text-xs text-slate-500">Username</label><input className="w-full border-b py-2 outline-none" value={data.username} onChange={e => setData({...data, username: e.target.value})} /></div>
                        <div><label className="text-xs text-slate-500">Bio</label><textarea className="w-full border-b py-2 outline-none resize-none" rows="2" value={data.bio} onChange={e => setData({...data, bio: e.target.value})} /></div>
                        <div className="flex items-center justify-between py-2"><label>Private Account</label><input type="checkbox" checked={data.isPrivate} onChange={e => setData({...data, isPrivate: e.target.checked})} /></div>
                        <p className="text-xs text-slate-400">If private, only followers can see your posts.</p>
                        <div className="mt-8 pt-6 border-t"><button onClick={handleDeleteAccount} className="w-full text-red-600 bg-red-50 py-3 rounded-xl font-bold hover:bg-red-100 transition text-sm">Delete Account Permanently</button></div>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD ---
        function Dashboard({ user, userData }) {
            const [view, setView] = useState('feed'); 
            const [posts, setPosts] = useState([]);
            const [following, setFollowing] = useState([]);
            const [viewingProfile, setViewingProfile] = useState(null);
            const [activeChat, setActiveChat] = useState(null);
            const [unreadCount, setUnreadCount] = useState(0);
            const [notifications, setNotifications] = useState([]);
            const [activePost, setActivePost] = useState(null);

            // Fetch Following list
            useEffect(() => {
                const q = query(collection(db, "friend_requests"), where("from", "==", user.uid), where("status", "==", "accepted"));
                const unsub = onSnapshot(q, (snap) => {
                    const ids = snap.docs.map(d => d.data().to);
                    setFollowing([...ids, user.uid]); 
                });
                return () => unsub();
            }, [user]);

            // Fetch Notifications
            useEffect(() => {
                const q = query(collection(db, "notifications"), where("to", "==", user.uid));
                const unsub = onSnapshot(q, (snap) => {
                    const notifs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    notifs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); 
                    setNotifications(notifs.slice(0, 20)); 
                });
                return () => unsub();
            }, [user]);

            // Fetch Feed Posts
            useEffect(() => {
                if (view === 'feed') {
                    const q = query(collection(db, "posts"), limit(50));
                    const unsub = onSnapshot(q, (snap) => {
                        let allPosts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        if (following.length > 0) {
                            allPosts = allPosts.filter(p => following.includes(p.userId));
                        } else {
                            allPosts = [];
                        }
                        allPosts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                        setPosts(allPosts);
                    });
                    return () => unsub();
                } else if (view === 'feed') {
                    setPosts([]); 
                }
            }, [view, following]);

            // Simple Unread Message Check
            useEffect(() => {
                const q = query(collection(db, "messages"), where("receiverId", "==", user.uid), limit(1));
            }, []);

            const addNotification = async (toUser, type, content = "") => {
                if(toUser === user.uid) return;
                await addDoc(collection(db, "notifications"), {
                    from: user.uid, fromName: user.displayName, to: toUser, type: type, content: content, timestamp: serverTimestamp()
                });
            };

            const handleLike = async (postId, isLiked, postOwnerId) => {
                const postRef = doc(db, "posts", postId);
                const postDoc = await getDoc(postRef);
                if (postDoc.exists()) {
                    let likes = postDoc.data().likes || [];
                    if (isLiked) likes = likes.filter(id => id !== user.uid);
                    else {
                        likes.push(user.uid);
                        addNotification(postOwnerId, "like");
                    }
                    await updateDoc(postRef, { likes });
                }
            };

            const handleComment = async (postId, text, postOwnerId) => {
                const postRef = doc(db, "posts", postId);
                const postDoc = await getDoc(postRef);
                if (postDoc.exists()) {
                    let comments = postDoc.data().comments || [];
                    comments.push({ userId: user.uid, username: user.displayName, text: text, timestamp: Date.now() });
                    await updateDoc(postRef, { comments });
                    addNotification(postOwnerId, "comment", text);
                }
            };

            const handleDeletePost = async (postId) => {
                if(confirm("Delete this post?")) {
                    await deleteDoc(doc(db, "posts", postId));
                }
            };

            const handleShare = (post) => {
                navigator.clipboard.writeText(`Check out this post: ${post.caption}`);
                alert("Link copied!");
            };

            const startChat = (targetUser) => {
                setViewingProfile(null);
                setActiveChat(targetUser);
                setView('messages');
            };

            return (
                <div className="h-screen flex flex-col bg-slate-50 overflow-hidden">
                    <Navbar user={user} userData={userData} onLogout={() => signOut(auth)} setView={setView} activeView={view} unreadCount={unreadCount} notifCount={notifications.length} />
                    
                    {viewingProfile && (
                        <UserProfileModal 
                            currentUser={userData} 
                            targetUser={viewingProfile} 
                            isAdmin={userData?.username === 'admin'} 
                            onClose={() => setViewingProfile(null)} 
                            onViewProfile={setViewingProfile}
                            onMessage={startChat}
                            onAddNotif={addNotification}
                            onViewPost={setActivePost}
                        />
                    )}

                    {activePost && (
                        <PostViewModal 
                            post={activePost}
                            currentUser={user}
                            onClose={() => setActivePost(null)}
                            onLike={handleLike}
                            onComment={handleComment}
                            onShare={handleShare}
                            onDelete={handleDeletePost}
                        />
                    )}

                    {view === 'create_post' && <CreatePostModal user={user} onClose={() => setView('feed')} />}

                    <div className="flex-1 overflow-y-auto w-full p-0 md:p-4 max-w-4xl mx-auto pb-20">
                        
                        {view === 'feed' && (
                            <div className="max-w-lg mx-auto">
                                {posts.length === 0 ? (
                                    <div className="text-center mt-10">
                                        <p className="text-xl font-insta mb-2">Welcome to Indiagram</p>
                                        <p className="text-sm text-slate-500">Follow people to see their photos here.</p>
                                        <button onClick={() => setView('explore')} className="text-blue-500 font-bold mt-2">Find People</button>
                                    </div>
                                ) : (
                                    posts.map(post => (
                                        <PostCard 
                                            key={post.id} 
                                            post={post} 
                                            currentUser={user} 
                                            onLike={handleLike} 
                                            onComment={handleComment}
                                            onShare={handleShare}
                                            onDelete={handleDeletePost}
                                            onViewProfile={setViewingProfile}
                                        />
                                    ))
                                )}
                            </div>
                        )}

                        {view === 'notifications' && (
                            <div className="max-w-md mx-auto bg-white rounded-lg shadow-sm border p-4">
                                <h3 className="font-bold text-lg mb-4">Notifications</h3>
                                {notifications.length === 0 ? <p className="text-slate-500 text-center">No notifications</p> : 
                                    notifications.map(n => (
                                        <div key={n.id} className="flex items-center gap-3 p-3 border-b last:border-0">
                                            <div className="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-600">{n.fromName[0]}</div>
                                            <div className="text-sm">
                                                <span className="font-bold">{n.fromName}</span> 
                                                {n.type === 'like' && ' liked your post.'}
                                                {n.type === 'comment' && ` commented: "${n.content}"`}
                                                {n.type === 'follow' && ' started following you.'}
                                                <p className="text-xs text-slate-400">{formatDateIST(n.timestamp)}</p>
                                            </div>
                                        </div>
                                    ))
                                }
                            </div>
                        )}

                        {view === 'explore' && (
                            <ExploreChatView 
                                user={user} 
                                userData={userData}
                                viewType={view} 
                                setViewingProfile={setViewingProfile}
                            />
                        )}

                        {view === 'messages' && (
                            <MessagesView 
                                user={user} 
                                activeChat={activeChat}
                                setActiveChat={setActiveChat}
                                onViewProfile={setViewingProfile} 
                            />
                        )}

                        {view === 'my_profile' && (
                            <MyProfile 
                                user={user} 
                                onEdit={() => setView('edit_profile')} 
                                onLogout={() => signOut(auth)} 
                                onViewProfile={setViewingProfile}
                                onViewPost={setActivePost}
                            />
                        )}

                        {view === 'edit_profile' && (
                            <EditProfile user={user} onClose={() => setView('my_profile')} />
                        )}
                    </div>
                </div>
            );
        }

        // --- ROOT APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                let isMounted = true;
                const safetyTimeout = setTimeout(() => { if (isMounted && loading) { console.warn("Loading timeout reached"); setLoading(false); } }, 5000); 

                const unsubAuth = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        try {
                            const userDoc = await getDoc(doc(db, "users", u.uid));
                            if (isMounted) {
                                if (userDoc.exists()) {
                                    const data = userDoc.data();
                                    if (data.isBanned) {
                                        alert("Your account has been disabled by the admin.");
                                        signOut(auth);
                                        setUser(null);
                                        setUserData(null);
                                    } else {
                                        setUserData(data);
                                        updateDoc(doc(db, "users", u.uid), { lastSeen: serverTimestamp() });
                                    }
                                }
                                setLoading(false);
                            }
                            onSnapshot(doc(db, "users", u.uid), (docSnap) => {
                                if (isMounted && docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.isBanned) {
                                        alert("Your account has been disabled by the admin.");
                                        signOut(auth);
                                    } else {
                                        setUserData(data);
                                    }
                                }
                            });
                        } catch (e) {
                            console.error("Error:", e);
                            if (isMounted) setLoading(false);
                        }
                    } else {
                        if (isMounted) {
                            setUser(null);
                            setUserData(null);
                            setLoading(false);
                        }
                    }
                });
                return () => { isMounted = false; clearTimeout(safetyTimeout); unsubAuth(); };
            }, []);

            if (loading) return <div className="h-screen flex items-center justify-center"><div className="loader"></div></div>;

            return user ? <Dashboard user={user} userData={userData} /> : <AuthPage setUser={setUser} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
